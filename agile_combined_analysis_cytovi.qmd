## script combining the analysis of the blood and blister data from the agile trial
## using cytovi (as opposed to catalyst in R)


## checking the gpu set up
```{python}
import torch
import torchmetrics
print(torch.__version__)
print(torch.cuda.is_available())
if torch.cuda.is_available():
    print(torch.cuda.get_device_name(0))
```

```{python}
import os
import random
import tempfile
import glob

import matplotlib.pyplot as plt  # type: ignore
import numpy as np  # type: ignore
import requests
import scanpy as sc  # type: ignore
import pandas as pd
import scvi
import torch  # type: ignore
from rich import print  # type: ignore
from scvi.external import cytovi  # type: ignore

os.environ["SCIPY_ARRAY_API"] = "1"

sc.set_figure_params(figsize=(4, 4))

scvi.settings.seed = 0
random.seed(42)
np.random.seed(42)
torch.manual_seed(42)
print("Last run with scvi-tools version:", scvi.__version__)
```

## tell scvi to use gpu where relevant (apparently this should spped up the heavy steps 10-50x!)
```{python}
scvi.settings.device = "cuda"
scvi.settings.seed = 0
```

## load in all fcs files from current working directory, excluding certain channels and not creating a sample column yet (whole file name will still be stored at this point)
```{python}
adata = cytovi.read_fcs(".", remove_markers=["FSC - Area", "SSC - Area", "Time Stamp", "Live-dead : Zombie-NIR - Area"], sample_name_extractor=None)
```

## make a new sample_full column that is the file name minus the redundant suffix
## also change the phrasing the blood data from "stained_blood" to just "blood"
```{python}
adata.obs["sample_full"] = adata.obs["filename"].str.replace(" WLSM_CD45 Pos.fcs", "", regex=False)
adata.obs["sample_full"] = adata.obs["sample_full"].str.replace("stained_blood", "blood", regex=False)
adata.obs
```

## now split the sample name by underscores (this contains donor, treatment, time etc) and then make these new columns
```{python}
parts = adata.obs["sample_full"].str.split("_", expand=True)
adata.obs["treatment"] = parts[0]
adata.obs["donor"]     = parts[1]
adata.obs["tissue"]    = parts[2]
adata.obs["time"]      = parts[3]
adata.obs
```

```{python}
# -----------------------------
# 2️⃣ Subsample blood cells proportionally
# -----------------------------
# Separate tissues
blister_cells = adata[adata.obs['tissue'] == "blister"].copy()
blood_cells = adata[adata.obs['tissue'] == "blood"].copy()

# Total number of blood cells to keep for plotting
target_blood_n = 100_000

# Compute proportions per donor
donor_counts = blood_cells.obs['donor'].value_counts()
donor_props = donor_counts / donor_counts.sum()

blood_subsample = []

for donor, prop in donor_props.items():
    donor_idx = blood_cells.obs[blood_cells.obs['donor'] == donor].index
    n_keep = int(np.round(prop * target_blood_n))
    if len(donor_idx) > n_keep:
        chosen = np.random.choice(donor_idx, size=n_keep, replace=False)
    else:
        chosen = donor_idx
    blood_subsample.extend(chosen)

# Combine with all blister cells
subset_idx = np.concatenate([blister_cells.obs.index, blood_subsample])
adata_sub = adata[subset_idx].copy()
```
## perform arcsinh transformation with a cofactor of 2000 (recommended in multiple tutorials)
```{python}
cytovi.transform_arcsinh(adata, global_scaling_factor=2000)
cytovi.scale(adata)
```

## downsample to 10,000 cells per sample 
## this mainly impacts the blood samples, as blisters dont reach this number
```{python}
adata_ds = cytovi.subsample(adata, groupby="sample_full", n_obs_group=10000)
numbers = adata_ds.obs.groupby("sample_full").size()
adata = adata_ds.copy()
del adata_ds
```

## free up memory after deleting big object
```{python}
import gc
gc.collect()
```

## rename markers 
```{python}
var_series = pd.Series(adata.var_names)
clean_names = var_series.str.split(":", expand=True)[0].str.strip()
adata.var_names = clean_names.values
```

## rename tissue groupings, as they are currently slightly different
```{python}
adata.obs["tissue"] = adata.obs["tissue"].map(
    {
        "blood":"blood",
        "blister":"blister",
        "Blister":"blister",
        "Blister1":"blister",
        "Blister2":"blister"
    }
)
```

## plot marker expression for inspection
```{python}
cytovi.plot_histogram(adata, marker="all", groupby="tissue", layer_key="scaled")
cytovi.plot_biaxial(adata, marker_x="CD3", marker_y="CD8", color="tissue", layer_key="scaled")
```

## save object here
```{python}
#adata.write("agile_combined_pre_model.h5ad")
adata = sc.read_h5ad("agile_combined_pre_model.h5ad")
```

## set up and train the cytovi model
```{python}
cytovi.CYTOVI.setup_anndata(adata, layer="scaled", batch_key="donor")
model = cytovi.CYTOVI(adata)
model.train(n_epochs_kl_warmup=20, max_epochs=100, batch_size=1024)
```

```{python}
plt.figure()
plt.plot(model.history["elbo_train"], label="Train")
plt.figure()
plt.plot(model.history["elbo_validation"], label="Validation")
plt.xlabel("Epochs")
plt.ylabel("ELBO")
plt.legend()
plt.title("Training vs Validation ELBO")
plt.show()
```

## add the new cytoviembedding
## compute neighbours and run leiden clustering on the full dataset
## 
```{python}
# -----------------------------
# 1️⃣ Compute neighbors and Leiden on full data
# -----------------------------
adata.obsm["X_CytoVI"] = model.get_latent_representation()
sc.pp.neighbors(adata, use_rep="X_CytoVI", n_neighbors=30)

```

```{python}
adata.layers["imputed"] = model.get_normalized_expression()
```

```{python}
#adata.write("agile_combined_modelled.h5ad")
adata = sc.read_h5ad("agile_combined_modelled.h5ad")
```

```{python}
sc.pl.umap(adata, color=["tissue", "time"])
```
```{python}
g = cytovi.plot_histogram(
    adata, marker=["CD62L", "CD16", "CD69"], layer_key="scaled", groupby="tissue", return_plot=True
)
g.fig.suptitle("Uncorrected expression", fontsize=16)

h = cytovi.plot_histogram(
    adata, marker=["CD62L", "CD16", "CD69"], layer_key="imputed", groupby="tissue", return_plot=True
)
h.fig.suptitle("Corrected expression", fontsize=16)
```

```{python}
plt.figure()
marker_umaps = sc.pl.umap(adata, color=adata.var_names, layer="imputed", ncols=5, cmap="rocket", show=False, vmax="p99")
plt.savefig("marker_umaps.png", dpi=300)
```