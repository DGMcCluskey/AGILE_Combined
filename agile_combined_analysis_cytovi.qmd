## script combining the analysis of the blood and blister data from the agile trial
## using cytovi (as opposed to catalyst in R)

```{python}
import torch
import torchmetrics
print(torch.__version__)
print(torch.cuda.is_available())
if torch.cuda.is_available():
    print(torch.cuda.get_device_name(0))
```

```{python}
import os
import random
import tempfile
import glob

import matplotlib.pyplot as plt  # type: ignore
import numpy as np  # type: ignore
import requests
import scanpy as sc  # type: ignore
import pandas as pd
import scvi
import torch  # type: ignore
from rich import print  # type: ignore
from scvi.external import cytovi  # type: ignore

os.environ["SCIPY_ARRAY_API"] = "1"

sc.set_figure_params(figsize=(4, 4))

scvi.settings.seed = 0
random.seed(42)
np.random.seed(42)
torch.manual_seed(42)
print("Last run with scvi-tools version:", scvi.__version__)
```

## tell scvi to use gpu where relevant (apparently this should spped up the heavy steps 10-50x!)
```{python}
scvi.settings.device = "cuda"
scvi.settings.seed = 0
```

## load in all fcs files from current working directory, excluding certain channels and not creating a sample column yet (whole file name will still be stored at this point)
```{python}
adata = cytovi.read_fcs(".", remove_markers=["FSC - Area", "SSC - Area", "Time Stamp", "Live-dead : Zombie-NIR - Area"], sample_name_extractor=None)
```

## make a new sample_full column that is the file name minus the redundant suffix
## also change the phrasing the blood data from "stained_blood" to just "blood"
```{python}
adata.obs["sample_full"] = adata.obs["filename"].str.replace(" WLSM_CD45 Pos.fcs", "", regex=False)
adata.obs["sample_full"] = adata.obs["sample_full"].str.replace("stained_blood", "blood", regex=False)
adata.obs
```

## now split the sample name by underscores (this contains donor, treatment, time etc) and then make these new columns
```{python}
parts = adata.obs["sample_full"].str.split("_", expand=True)
adata.obs["treatment"] = parts[0]
adata.obs["donor"]     = parts[1]
adata.obs["tissue"]    = parts[2]
adata.obs["time"]      = parts[3]
adata.obs
```

## perform arcsinh transformation with a cofactor of 2000 (recommended in multiple tutorials)
```{python}
cytovi.transform_arcsinh(adata, global_scaling_factor=2000)
cytovi.scale(adata)
```

## downsample to 20,000 cells per sample 
## this mainly impacts the blood samples, as blisters dont reach this number
```{python}
adata_ds = cytovi.subsample(adata, groupby="sample_full", n_obs_group=20000)
numbers = adata_ds.obs.groupby("sample_full").size()
adata = adata_ds.copy()
del adata_ds
```

## free up memory after deleting big object
```{python}
import gc
gc.collect()
```

## rename markers 
```{python}
var_series = pd.Series(adata.var_names)
clean_names = var_series.str.split(":", expand=True)[0].str.strip()
adata.var_names = clean_names.values
```

## rename tissue groupings, as they are currently slightly different
```{python}
adata.obs["tissue"] = adata.obs["tissue"].map(
    {
        "blood":"blood",
        "blister":"blister",
        "Blister":"blister",
        "Blister1":"blister",
        "Blister2":"blister"
    }
)
```

## plot marker expression for inspection
```{python}
cytovi.plot_histogram(adata, marker="all", groupby="tissue", layer_key="scaled")
cytovi.plot_biaxial(adata, marker_x="CD3", marker_y="CD8", color="tissue", layer_key="scaled")
```

## run clustering and umap without batch correction
```{python}
adata.X = adata.layers["scaled"]
sc.pp.neighbors(adata, use_rep="X", transformer="pynndescent")
sc.tl.umap(adata)
sc.pl.umap(adata, color="donor")
```

## set up and train the cytovi model
```{python}
cytovi.CYTOVI.setup_anndata(adata, layer="scaled", batch_key="donor")
model = cytovi.CYTOVI(adata)
model.train(n_epochs_kl_warmup=50)
```