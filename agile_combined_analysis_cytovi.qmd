## script combining the analysis of the blood and blister data from the agile trial
## using cytovi (as opposed to catalyst in R)


## checking the gpu set up
```{python}
import torch
import torchmetrics
print(torch.__version__)
print(torch.cuda.is_available())
if torch.cuda.is_available():
    print(torch.cuda.get_device_name(0))
```

```{python}
import os
import random
import tempfile
import glob

import matplotlib.pyplot as plt  # type: ignore
from matplotlib import rcParams
import numpy as np  # type: ignore
import requests
import scanpy as sc  # type: ignore
import pandas as pd
import scvi
import torch  # type: ignore
from rich import print  # type: ignore
from scvi.external import cytovi  # type: ignore
import seaborn as sns
import seaborn.objects as so
from plotnine import *
import statsmodels.formula.api as smf

os.environ["SCIPY_ARRAY_API"] = "1"

sc.set_figure_params(figsize=(4, 4))

scvi.settings.seed = 0
random.seed(42)
np.random.seed(42)
torch.manual_seed(42)
print("Last run with scvi-tools version:", scvi.__version__)
```

## tell scvi to use gpu where relevant (apparently this should spped up the heavy steps 10-50x!)
```{python}
scvi.settings.device = "cuda"
scvi.settings.seed = 0
```

## load in all fcs files from current working directory, excluding certain channels and not creating a sample column yet (whole file name will still be stored at this point)
```{python}
adata = cytovi.read_fcs(".", remove_markers=["FSC - Area", "SSC - Area", "Time Stamp", "Live-dead : Zombie-NIR - Area"], sample_name_extractor=None)
```

## make a new sample_full column that is the file name minus the redundant suffix
## also change the phrasing the blood data from "stained_blood" to just "blood"
```{python}
adata.obs["sample_full"] = adata.obs["filename"].str.replace(" WLSM_CD45 Pos.fcs", "", regex=False)
adata.obs["sample_full"] = adata.obs["sample_full"].str.replace("stained_blood", "blood", regex=False)
adata.obs
```

## now split the sample name by underscores (this contains donor, treatment, time etc) and then make these new columns
```{python}
parts = adata.obs["sample_full"].str.split("_", expand=True)
adata.obs["treatment"] = parts[0]
adata.obs["donor"]     = parts[1]
adata.obs["tissue"]    = parts[2]
adata.obs["time"]      = parts[3]
adata.obs
```

## rename tissue groupings, as they are currently slightly different
```{python}
adata.obs["tissue"] = adata.obs["tissue"].map(
    {
        "blood":"blood",
        "blister":"blister",
        "Blister":"blister",
        "Blister1":"blister",
        "Blister2":"blister"
    }
)
```

```{python}
# -----------------------------
# 2Subsample blood cells proportionally
# -----------------------------
# Separate tissues
blister_cells = adata[adata.obs['tissue'] == "blister"].copy()
blood_cells = adata[adata.obs['tissue'] == "blood"].copy()

# Total number of blood cells to keep for plotting
target_blood_n = 100_000

# Compute proportions per donor
sample_counts = blood_cells.obs['sample_full'].value_counts()
sample_props = sample_counts / sample_counts.sum()

blood_subsample = []

for sample, prop in sample_props.items():
    sample_idx = blood_cells.obs[blood_cells.obs['sample_full'] == sample].index
    n_keep = int(np.round(prop * target_blood_n))
    if len(sample_idx) > n_keep:
        chosen = np.random.choice(sample_idx, size=n_keep, replace=False)
    else:
        chosen = sample_idx
    blood_subsample.extend(chosen)

# Combine with all blister cells
subset_idx = np.concatenate([blister_cells.obs.index, blood_subsample])
adata = adata[subset_idx].copy()
adata.obs.groupby(["tissue", "time"]).size()
```

## perform arcsinh transformation with a cofactor of 2000 (recommended in multiple tutorials)
```{python}
cytovi.transform_arcsinh(adata, global_scaling_factor=2000)
cytovi.scale(adata)
```

## free up memory
```{python}
import gc
gc.collect()
```

## rename markers 
```{python}
var_series = pd.Series(adata.var_names)
clean_names = var_series.str.split(":", expand=True)[0].str.strip()
adata.var_names = clean_names.values
```

## plot marker expression for inspection
```{python}
cytovi.plot_histogram(adata, marker="all", groupby="tissue", layer_key="scaled")
cytovi.plot_biaxial(adata, marker_x="CD3", marker_y="CD8", color="tissue", layer_key="scaled")
```

## save object here
```{python}
#adata.write("agile_combined_pre_model.h5ad")
adata = sc.read_h5ad("agile_combined_pre_model.h5ad")
```

## set up and train the cytovi model
```{python}
cytovi.CYTOVI.setup_anndata(adata, layer="scaled", batch_key="donor")
model = cytovi.CYTOVI(adata)
model.train(n_epochs_kl_warmup=20, max_epochs=100, batch_size=1024)
```

```{python}
plt.figure()
plt.plot(model.history["elbo_train"], label="Train")
plt.figure()
plt.plot(model.history["elbo_validation"], label="Validation")
plt.xlabel("Epochs")
plt.ylabel("ELBO")
plt.legend()
plt.title("Training vs Validation ELBO")
plt.show()
```

## add the new cytovi embedding
## compute neighbours
## 
```{python}
adata.obsm["X_CytoVI"] = model.get_latent_representation()
sc.pp.neighbors(adata, use_rep="X_CytoVI", n_neighbors=30)
```

```{python}
sc.tl.umap(adata)
sc.pl.umap(adata, color="tissue")
```

```{python}
adata.layers["imputed"] = model.get_normalized_expression()
```

```{python}
adata.write("agile_combined_modelled.h5ad")
adata = sc.read_h5ad("agile_combined_modelled.h5ad")
```

```{python}
sc.pl.umap(adata, color=["tissue", "time"])
```

```{python}
g = cytovi.plot_histogram(
    adata, marker=["CD62L", "CD16", "CD69"], layer_key="scaled", groupby="tissue", return_plot=True
)
g.fig.suptitle("Uncorrected expression", fontsize=16)

h = cytovi.plot_histogram(
    adata, marker=["CD62L", "CD16", "CD69"], layer_key="imputed", groupby="tissue", return_plot=True
)
h.fig.suptitle("Corrected expression", fontsize=16)
```

```{python}
plt.figure()
marker_umaps = sc.pl.umap(adata, color=adata.var_names, layer="imputed", ncols=5, cmap="mako", show=False, vmax="p99")
plt.savefig("marker_umaps.png", dpi=300)
```

```{python}
sc.tl.leiden(adata, resolution=0.4, key_added="leiden_CytoVI", flavor="igraph")
sc.pl.umap(adata, color="leiden_CytoVI", legend_loc="on data")
sc.pl.umap(adata, color="time")
```

```{python}
sc.pl.matrixplot(
    adata,
    var_names=adata.var_names,
    groupby="leiden_CytoVI",
    layer="imputed",
    dendrogram=True,
    standard_scale="var",
    cmap="mako",
)
```

```{python}
sc.pl.stacked_violin(adata, var_names=adata.var_names, groupby="leiden_CytoVI", layer="imputed", stripplot=False, use_raw=False)
```

```{python}
potential_neuts= adata[adata.obs["leiden_CytoVI"].isin(["13","18","16","17","8"])].copy()
cytovi.plot_histogram(
    potential_neuts, marker=["CD62L", "CD16", "CD184", "CD15", "CD182"], layer_key="imputed", groupby="leiden_CytoVI", return_plot=True
)
```
```{python}
cell_annotation_dict = {
    "0": "CD8+T_blister",
    "1": "NK_blister",
    "2": "CD4+T_blister",
    "3": "Classical_monocyte_blister",
    "4": "CD8+T_blister",
    "5": "DC_mixed",
    "6": "DC_blister",
    "7": "CD8+T_blister",
    "8": "Neutrophil_old_blister",
    "9": "CD8+T_blood",
    "10": "Treg_blister",
    "11": "NK_blood",
    "12": "CD4+T_blood",
    "13": "Neutrophil_aged_blood",
    "14": "Classical_monocyte_blood",
    "15": "NKT_blister",
    "16": "Neutrophil_young_blood",
    "17": "Neutrophil_mature_blood",
    "18": "Neutrophil_mature_blood"
}

adata.obs["label"] = adata.obs["leiden_CytoVI"].map(cell_annotation_dict)
cluster_palette= ["green", "limegreen", "red", "darkred", "hotpink", "mediumvioletred", "darkorchid", "mediumpurple", "grey", "goldenrod", "orange", "navy", "blue", "deepskyblue", "cyan", "royalblue", "lightcoral"]
```

```{python}
rcParams["figure.figsize"] = (10, 10)
plt.figure()
sc.pl.umap(adata, color="label", legend_loc="on data", legend_fontoutline=2, frameon = False, size =5, palette=cluster_palette, legend_fontsize="small", title="annotated UMAP")
plt.savefig("UMAP_annotated.png", dpi=300)
```

```{python}
plt.figure()
sc.pl.matrixplot(
    adata,
    var_names=["CD3", "CD4", "CD8", "FOXP3", "CD56", "CD14", "CD16", "CD1c", "HLA-DR", "CD66b", "CD15", "CD62L"],
    groupby="label",
    layer="imputed",
    dendrogram=True,
    standard_scale="var",
    cmap="mako_r",
    figsize=(12,7)
)
plt.savefig("annotated_heatmap.png", dpi=300)
```

## some treatment names are wrong so unifying
## make sure 4h times are combined with 6h
```{python}
treatment_dict = {
    "Guinness":"Guinness",
    "guinness":"Guinness",
    "Corona":"Corona",
    "corona":"Corona"
}

adata.obs["treatment_clean"] = adata.obs["treatment"].map(treatment_dict)


time_dict = {
    "-72h":"-72h",
    "0h":"0h",
    "4h":"6h",
    "6h":"6h",
    "24h":"24h",
    "48h":"48h",
    "72h":"72h"
}
adata.obs["time_clean"] = adata.obs["time"].map(time_dict)
```

```{python}
df = adata.obs

counts = df.groupby(["label", "tissue"]).size().unstack(fill_value=0)
props  = counts.div(counts.sum(axis=1), axis=0).reset_index().melt(
    id_vars="label",
    var_name="tissue",
    value_name="prop"
)
p = so.Plot(props, y="label", x = "prop", color="tissue").add(so.Bar(), so.Stack())
fig=p.plot()._figure
fig.savefig("tissue_cluster_proportions.png", dpi=300, bbox_inches="tight")
```


```{python}
df = adata.obs.copy()

df_blood = df[df["tissue"] == "blood"].copy()
df_blister = df[df["tissue"] == "blister"].copy()


# Count cells per donor × time × treatment × label
blood_counts = (
    df_blood.groupby(["donor", "time_clean", "treatment_clean", "label"])
      .size()
      .reset_index(name="count")
)

# Compute proportions within each donor × time × treatment
blood_counts["prop"] = blood_counts.groupby(["donor", "time_clean", "treatment_clean"])["count"].transform(lambda x: x / x.sum()*100)

# Count cells per donor × time × treatment × label
blister_counts = (
    df_blister.groupby(["donor", "time_clean", "treatment_clean", "label"])
      .size()
      .reset_index(name="count")
)

# Compute proportions within each donor × time × treatment
blister_counts["prop"] = blister_counts.groupby(["donor", "time_clean", "treatment_clean"])["count"].transform(lambda x: x / x.sum()*100)

```

```{python}
time_order = ["-72h", "0h", "6h", "24h", "48h", "72h"]
blood_counts['time_clean'] = pd.Categorical(
    blood_counts['time_clean'],
    categories=time_order,
    ordered=True
)

# Remove rows where 'prop' is NaN
blood_counts = blood_counts.dropna(subset=['prop'])

# Keep only rows where 'label' contains "blood"
blood_counts = blood_counts[blood_counts['label'].str.contains("blood", case=False)]

if pd.api.types.is_categorical_dtype(blood_counts['label']):
    blood_counts['label'] = blood_counts['label'].cat.remove_unused_categories()

blood_plot = sns.catplot(
    data=blood_counts,
    x="time_clean",
    y="prop",
    col="label",
    col_wrap=4,
    hue="treatment_clean",
    palette=["mediumseagreen", "darkorchid"],
    height=5,
    aspect=1.5,
    kind="point",         # Must specify kind
    ci=None,              # Works with point plots
    sharey=False,
    markers='o',          # Point markers
    linestyles='-',       # Connect points with lines
)

```

## export dataframes for use in an R script to perform lmer
```{python}
blood_counts.to_csv("agile_blood_proportions_df.csv", index=False)
blister_counts.to_csv("agile_blister_proportions_df.csv", index=False)
```