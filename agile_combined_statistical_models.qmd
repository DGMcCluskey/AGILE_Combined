---
title: "Untitled"
format: html
---

```{r}
library(lme4)
library(lmerTest)   # adds p-values to lmer
library(emmeans)    # estimated marginal means
library(dplyr)
library(purrr)
library(readr)
library(viridis)
library(readxl)
library(ggplot2)
library(tidyr)
library(RColorBrewer)
library(patchwork)
```

```{r}
blood_df <- read.csv("agile_blood_proportions_df.csv")
blister_df <- read.csv("agile_blister_proportions_df.csv")
donor_info <- read_xlsx("Participant_info.xlsx")
donor_info$donor <- donor_info$`Participant ID`
blood_df <- blood_df %>%
  left_join(donor_info %>% select(donor, Age,), by = "donor")
blister_df <- blister_df %>%
  left_join(donor_info %>% select(donor, Age,), by = "donor")
```

```{r}
## Factors
blood_df$time_clean <- factor(blood_df$time_clean, levels = c("-72h","0h","6h","24h","48h","72h"))
blood_df$treatment_clean <- factor(blood_df$treatment_clean)

## Unique clusters
clusters <- unique(blood_df$label)

## Storage
interaction_list <- list()

for (cl in clusters) {
  
  message("Running model for cluster: ", cl)
  
  d <- blood_df %>% filter(label == cl)
  
  # Fit mixed model
  m <- lmer(prop ~ treatment_clean * time_clean + Age + (1 | donor), data = d)
  
  # EMMs
  emm <- emmeans(m, ~ treatment_clean * time_clean)
  
  # Treatment contrasts within each timepoint
  inter <- contrast(emm, method = "pairwise", by = "time_clean")
  inter_df <- as.data.frame(inter)
  inter_df$label <- cl
  
  # FDR correction within **each cluster × time**
  inter_df <- inter_df %>%
    group_by(time_clean) %>%
    mutate(p_adj_fdr = p.adjust(p.value, method = "fdr")) %>%
    ungroup()
  
  # Keep only the treatment comparison of interest (e.g., "drug - control")
  inter_df <- inter_df %>% filter(grepl("-", contrast))
  
  interaction_list[[cl]] <- inter_df
}

## Combine all clusters
interaction_results <- bind_rows(interaction_list)

## Save results
write_csv(interaction_results, "interaction_results_FDR_cluster_time.csv")
message("Saved: interaction_results_FDR_cluster_time.csv")

## Heatmap
heatmap_df <- interaction_results %>%
  select(label, time_clean, p_adj_fdr) %>%
  mutate(sig = case_when(
    p_adj_fdr < 0.001 ~ "***",
    p_adj_fdr < 0.01  ~ "**",
    p_adj_fdr < 0.05  ~ "*",
    TRUE ~ ""
  ))

ggplot(heatmap_df, aes(x = time_clean, y = label, fill = -log10(p_adj_fdr))) +
  geom_tile(color = "white") +
  geom_text(aes(label = sig), color = "white", size = 10) +
  scale_fill_viridis(option = "rocket", direction = 1, limits = c(0,1), name = "FDR p-value") +
  theme_minimal(base_size = 14) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid = element_blank()
  ) +
  labs(title = "Treatment Differences per Cluster × Timepoint",
       x = "Timepoint", y = "Cluster")

heatmap_df_blood <- interaction_results %>%
  select(label, time_clean, p_adj_fdr, estimate) %>%
  mutate(sig = case_when(
    p_adj_fdr < 0.001 ~ "***",
    p_adj_fdr < 0.01  ~ "**",
    p_adj_fdr < 0.05  ~ "*",
    TRUE ~ ""
  ))

p_blood <- ggplot(heatmap_df_blood, aes(x = time_clean, y = label, fill = estimate)) +
  geom_tile(colour="black")+
  geom_text(aes(label = sig), color = "black", size = 10) +
  scale_fill_distiller(palette = "RdBu", n = "Difference") +
  theme_minimal(base_size = 14) +
  theme(panel.grid = element_blank(),
    axis.text=element_text(size=12,colour="black")
  ) +
  labs(title = "Difference in blood cluster proportions Guinness vs Corona",
       x = "Timepoint", y = "Cluster")
p_blood

```

```{r}
## Factors
blister_df$time_clean <- factor(blister_df$time_clean, levels = c("6h","24h","48h","72h"))
blister_df$treatment_clean <- factor(blister_df$treatment_clean)

## Unique clusters
clusters <- unique(blister_df$label)

## Storage
interaction_list <- list()

for (cl in clusters) {
  
  message("Running model for cluster: ", cl)
  
  d <- blister_df %>% filter(label == cl)
  
  # Fit mixed model
  m <- lmer(prop ~ treatment_clean * time_clean + Age + (1 | donor), data = d)
  
  # EMMs
  emm <- emmeans(m, ~ treatment_clean * time_clean)
  
  # Treatment contrasts within each timepoint
  inter <- contrast(emm, method = "pairwise", by = "time_clean")
  inter_df <- as.data.frame(inter)
  inter_df$label <- cl
  
  # FDR correction within **each cluster × time**
  inter_df <- inter_df %>%
    group_by(time_clean) %>%
    mutate(p_adj_fdr = p.adjust(p.value, method = "fdr")) %>%
    ungroup()
  
  # Keep only the treatment comparison of interest (e.g., "drug - control")
  inter_df <- inter_df %>% filter(grepl("-", contrast))
  
  interaction_list[[cl]] <- inter_df
}

## Combine all clusters
interaction_results <- bind_rows(interaction_list)

## Save results
write_csv(interaction_results, "interaction_results_FDR_cluster_time.csv")
message("Saved: interaction_results_FDR_cluster_time.csv")

## Heatmap
heatmap_df <- interaction_results %>%
  select(label, time_clean, p_adj_fdr, estimate) %>%
  mutate(sig = case_when(
    p_adj_fdr < 0.001 ~ "***",
    p_adj_fdr < 0.01  ~ "**",
    p_adj_fdr < 0.05  ~ "*",
    TRUE ~ ""
  ))

ggplot(heatmap_df, aes(x = time_clean, y = label, fill = p_adj_fdr)) +
  geom_tile(color = "white") +
  geom_text(aes(label = sig), color = "white", size = 10) +
  scale_fill_viridis(option = "rocket", direction = 1, limits = c(0,1), name = "FDR p-value") +
  theme_minimal(base_size = 14) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid = element_blank()
  ) +
  labs(title = "Treatment Differences per Cluster × Timepoint",
       x = "Timepoint", y = "Cluster")

heatmap_df_blister <- interaction_results %>%
  select(label, time_clean, p_adj_fdr, estimate) %>%
  mutate(sig = case_when(
    p_adj_fdr < 0.001 ~ "***",
    p_adj_fdr < 0.01  ~ "**",
    p_adj_fdr < 0.05  ~ "*",
    TRUE ~ ""
  ))

p_blister <- ggplot(heatmap_df_blister, aes(x = time_clean, y = label, fill = estimate)) +
  geom_tile(colour="black")+
  geom_text(aes(label = sig), color = "black", size = 10) +
  scale_fill_distiller(palette = "RdBu", n = "Difference") +
  theme_minimal(base_size = 14) +
  theme(panel.grid = element_blank(),
    axis.text=element_text(size=12,colour="black")
  ) +
  labs(title = "Difference in blister cluster proportions Guinness vs Corona",
       x = "Timepoint", y = "Cluster")

p_blister
```

```{r}
heatmap_df_blood$tissue <- "blood"
heatmap_df_blister$tissue <- "blister"
heatmap_df_combined <- rbind(heatmap_df_blood, heatmap_df_blister)

p1  <- quantile(heatmap_df_combined$estimate, 0.01, na.rm = TRUE)
p99 <- quantile(heatmap_df_combined$estimate, 0.99, na.rm = TRUE)
lim <- max(abs(p1), abs(p99))

heatmap_df_combined <- heatmap_df_combined %>%
  mutate(estimate_capped = pmax(pmin(estimate, lim), -lim))


heatmap_plot_combined <- ggplot(heatmap_df_combined, aes(x = time_clean, y = label, fill = estimate_capped)) +
  geom_tile(colour="black")+
  geom_text(aes(label = sig), color = "black", size = 5, vjust = 0.5, hjust = 0.5) +
  scale_fill_distiller(palette = "RdBu", n = "Difference", limits=c(-lim,lim)) +
  theme_minimal(base_size = 14) +
  theme(panel.grid = element_blank(),
    axis.text=element_text(size=12,colour="black")
  ) +
  labs(title = "Difference in cluster proportions Corona - Guinness",
       x = "Timepoint", y = NULL)+
        facet_wrap(~tissue, scales = "free_y", ncol=1)+
  theme(axis.text=element_text(size=14,colour="black"))+
  theme(strip.text=element_text(size=14,colour="black", face="bold"))

heatmap_plot_combined
ggsave(plot = heatmap_plot_combined, filename = "proportions_diff_heatmap.png", dpi=300,height=8,width=8)
```

```{r}
emm_list <- list()
clusters <- unique(blood_df$label)

for(cl in clusters){
  
  d <- blood_df %>% filter(label == cl)
  
  # Fit mixed model
  m <- lmer(prop ~ treatment_clean * time_clean + Age + (1 | donor), data = d)
  
  # Estimated marginal means
  emm <- emmeans(m, ~ treatment_clean | time_clean)
  emm_df <- as.data.frame(emm)
  emm_df$label <- cl
  
  emm_list[[cl]] <- emm_df
}

emm_results_blood <- bind_rows(emm_list)

# Plot longitudinal EMMs
ggplot(emm_results_blood, aes(x = time_clean, y = emmean, color = treatment_clean, group = treatment_clean)) +
  geom_point(size = 3) +
  geom_line(size = 1.2) +
  geom_errorbar(aes(ymin = emmean - SE, ymax = emmean + SE), width = 0.2) +
  facet_wrap(~ label, scales = "free_y") +
  theme_minimal(base_size = 14) +
  labs(x = "Timepoint", y = "Estimated proportion", color = "Treatment") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  scale_colour_manual(values = c("mediumseagreen", "darkorchid"))+
  theme(axis.text = element_text(colour="black", size = 14),
  strip.text=element_text(colour="black", size=16, face="bold"))+
    ylab("Estimated % of blood cells")
```

```{r}
emm_list <- list()
clusters <- unique(blister_df$label)

for(cl in clusters){
  
  d <- blister_df %>% filter(label == cl)
  
  # Fit mixed model
  m <- lmer(prop ~ treatment_clean * time_clean + Age + (1 | donor), data = d)
  
  # Estimated marginal means
  emm <- emmeans(m, ~ treatment_clean | time_clean)
  emm_df <- as.data.frame(emm)
  emm_df$label <- cl
  
  emm_list[[cl]] <- emm_df
}

emm_results_blister <- bind_rows(emm_list)

# Plot longitudinal EMMs
ggplot(emm_results_blister, aes(x = time_clean, y = emmean, color = treatment_clean, group = treatment_clean)) +
  geom_point(size = 3) +
  geom_line(size = 1.2) +
  geom_errorbar(aes(ymin = emmean - SE, ymax = emmean + SE), width = 0.2) +
  facet_wrap(~ label, scales = "free_y") +
  theme_minimal(base_size = 14) +
  labs(x = "Timepoint", y = "Estimated proportion", color = "Treatment") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  scale_colour_manual(values = c("mediumseagreen", "darkorchid"))+
  theme(axis.text = element_text(colour="black", size = 14),
  strip.text=element_text(colour="black", size=16, face="bold"))+
    ylab("Estimated % of blister cells")
```

```{r}
emm_all <- rbind(emm_results_blood, emm_results_blister)
emm_all$celltype <- sub("_[^_]+$", "", emm_all$label)
emm_all$tissue <- sub(".*_", "", emm_all$label)
emm_all$group <- paste0(emm_all$tissue, "_", emm_all$treatment_clean)

ggplot(emm_all, aes(x = time_clean, y = emmean, color = group, group = group, shape = group)) +
  geom_point(size = 3, position=position_dodge(width=0.5)) +
  geom_line(size = 1.2, position=position_dodge(width=0.5)) +
  geom_errorbar(aes(ymin = emmean - SE, ymax = emmean + SE), width = 0.2, position=position_dodge(width=0.5)) +
  facet_wrap(~ celltype, scales = "free_y") +
  theme_minimal(base_size = 14) +
  labs(x = "Timepoint", y = "Estimated % of blood/blister cells") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  scale_colour_manual(values = c("mediumseagreen", "palevioletred2", "darkgreen", "darkorchid"))+
  theme(axis.text = element_text(colour="black", size = 14),
  strip.text=element_text(colour="black", size=16, face="bold"))+
    scale_shape_manual(values=c(16,15,17,18))
```

## plot only specific celltypes based on the initial heatmap
```{r}
emm_myeloid <- filter(emm_all, label %in% c("DC_blister", "CD1c+_blister"))

emm_neuts <- filter(emm_all, label %in% c("Neutrophil_mature_blood", "Neutrophil_mature_blister", "Neutrophil_aged_blood", "Neutrophil_immature_blood", "Neutrophil_aged_blister"))

emm_neuts$label <- factor(emm_neuts$label, levels=c("Neutrophil_immature_blood", "Neutrophil_mature_blood", "Neutrophil_aged_blood", "Neutrophil_mature_blister", "Neutrophil_aged_blister"))


longitudinal_neuts <- ggplot(emm_neuts, aes(x = time_clean, y = emmean, color = treatment_clean, group=treatment_clean)) +
  geom_point(size = 3, position=position_dodge(width=0)) +
  geom_line(size = 1.2, position=position_dodge(width=0)) +
  geom_errorbar(aes(ymin = emmean - SE, ymax = emmean + SE), width = 0.2, position=position_dodge(width=0)) +
  facet_wrap(~ label, scales = "free_y") +
  theme_minimal(base_size = 14) +
  labs(x = "Timepoint", y = "Estimated % of blood/blister cells") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  scale_colour_manual(values = c("mediumseagreen","darkorchid"))+
  theme(axis.text = element_text(colour="black", size = 12),
  strip.text=element_text(colour="black", size=12, face="bold"))+
    scale_shape_manual(values=c(16,15,17,18))
longitudinal_neuts

longitudinal_myeloid <- ggplot(emm_myeloid, aes(x = time_clean, y = emmean, color = treatment_clean, group=treatment_clean)) +
  geom_point(size = 3, position=position_dodge(width=0)) +
  geom_line(size = 1.2, position=position_dodge(width=0)) +
  geom_errorbar(aes(ymin = emmean - SE, ymax = emmean + SE), width = 0.2, position=position_dodge(width=0)) +
  facet_wrap(~ label, scales = "free_y") +
  theme_minimal(base_size = 14) +
  labs(x = "Timepoint", y = "Estimated % of blood/blister cells") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  scale_colour_manual(values = c("mediumseagreen","darkorchid"))+
  theme(axis.text = element_text(colour="black", size = 12),
  strip.text=element_text(colour="black", size=12, face="bold"))+
    scale_shape_manual(values=c(16,15,17,18))
longitudinal_myeloid

ggsave(plot = longitudinal_neuts, filename = "neut_props.png", dpi=300, height = 5, width=12)
ggsave(plot = longitudinal_myeloid, filename = "myeloid_props.png", dpi=300, height = 3, width=7)
```

## combine heatmap and long plots into one
```{r}
plot_final <- heatmap_plot_combined+longitudinal_plots+plot_layout(ncol=2, widths=c(1,3))
plot_final
ggsave(plot=plot_final, filename="proportions_over_time.png", dpi=300,
height=6, width=14)
```

## to try and plot this data in a digestible way, i'm taking inspiration from the dotplot style longitdinal proportion data you see in scRNA-seq papers
```{r}
ggplot(emm_all, aes(x=time_clean, y = celltype, fill = estimated_mean, size = ))
```

## modelling marker expression
## start with an overview heatmap to see if there are notable patterns
```{r}
summary_df <- read.csv("agile_combined_expression_df.csv")
summary_df <- summary_df[, -c(1:3, 9:12, 16:22)]
summary_df <-  pivot_longer(summary_df, names_to="marker", values_to="expression", cols=9:39)
sample_check <- summary_df %>%
  group_by(treatment_clean, time_clean, tissue) %>%
  summarise(n_samples = n_distinct(sample_full)) %>%
  ungroup()

sample_check

mean_exp <- summary_df %>% group_by(sample_full, donor, time_clean, treatment_clean, label, tissue,marker) %>% summarise(mean_expression = mean(expression), .groups="drop")
```

## for this to make sense, blister/blood populations should only have the times they were actually collected. additionally, only markers relevant to clusters should be shown, so further subsetting required. finally, scaled expression required too
```{r}
neuts <- filter(mean_exp, label %in% c("Neutrophil_mature_blood", "Neutrophil_mature_blister", "Neutrophil_aged_blood", "Neutrophil_immature_blood", "Neutrophil_aged_blister"))
neuts <- filter(neuts, marker %in% c("CD16", "CD14", "CCR6", "CD47","CD66b", "HLA-DR", "CD182", "CD184", "CD15", "CD11b", "CD62L"))
ggplot(neuts, aes(x=time_clean, y = marker, fill = mean_expression))+geom_tile()+facet_wrap(~label)

```

```{r}
labels <- unique(mean_exp$label)
labels <- labels[labels %in% c("Neutrophil_mature_blood", "Neutrophil_mature_blister", "Neutrophil_aged_blood", "Neutrophil_immature_blood", "Neutrophil_aged_blister")]
markers <- unique(mean_exp$marker)
markers <- markers[markers %in% c("CD16", "CD14", "CCR6", "CD47","CD66b", "HLA-DR", "CD182", "CD184", "CD15", "CD11b", "CD62L")]

interaction_list <- list()

for (lab in labels) {

  message("Running models for label (cluster): ", lab)

  # Determine tissue from label name
  tissue_for_label <- ifelse(grepl("_blood$", lab), "blood", "blister")

  message("  Using tissue: ", tissue_for_label)

  # Filter data for correct label + tissue
  model_input_label <- mean_exp %>%
    filter(label == lab, tissue == tissue_for_label)

  for (m in markers) {

    message("    → marker: ", m)

    d <- model_input_label %>% filter(marker == m)

    # Skip if there's no usable data
    if (nrow(d) < 5 || length(unique(d$donor)) < 2) next

    # Mixed model
    mod <- lmer(mean_expression ~ treatment_clean * time_clean + (1 | donor),
                data = d)

    emm <- emmeans(mod, ~ treatment_clean * time_clean)
    inter <- contrast(emm, method = "pairwise", by = "time_clean")
    inter_df <- as.data.frame(inter)

    inter_df$label  <- lab
    inter_df$marker <- m
    inter_df$tissue <- tissue_for_label

    # FDR correction per timepoint
    inter_df <- inter_df %>%
      group_by(time_clean) %>%
      mutate(p_adj_fdr = p.adjust(p.value, method = "fdr")) %>%
      ungroup()

    # Keep drug - control comparisons only
    inter_df <- inter_df %>% filter(grepl("-", contrast))

    interaction_list[[paste(lab, m, sep = "__")]] <- inter_df
  }
}

interaction_results <- bind_rows(interaction_list)
p1  <- quantile(interaction_results$estimate, 0.01, na.rm = TRUE)
p99 <- quantile(interaction_results$estimate, 0.99, na.rm = TRUE)
lim <- max(abs(p1), abs(p99))

interaction_results <- interaction_results %>%
  mutate(estimate_capped = pmax(pmin(estimate, lim), -lim))

heatmap_df <- interaction_results %>%
  select(label, time_clean, tissue, marker, p_adj_fdr, estimate_capped) %>%
  mutate(sig = case_when(
    p_adj_fdr < 0.001 ~ "***",
    p_adj_fdr < 0.01  ~ "**",
    p_adj_fdr < 0.05  ~ "*",
    TRUE ~ ""
  ))
```

```{r}
heatmap_df$label <- factor(heatmap_df$label, levels=c("Neutrophil_immature_blood", "Neutrophil_mature_blood", "Neutrophil_aged_blood", "Neutrophil_mature_blister", "Neutrophil_aged_blister"))

heatmap_df$time_clean <- factor(heatmap_df$time_clean, levels = c("-72h", "0h", "6h", "24h", "48h", "72h"))
p <- ggplot(heatmap_df, aes(x = time_clean, y = marker, fill = estimate_capped)) +
  geom_tile(colour="black")+
  geom_text(aes(label = sig), color = "black", size = 5, vjust = 0.5, hjust = 0.5) +
  scale_fill_distiller(palette = "RdBu", n = "Difference", limits=c(-lim,lim)) +
  theme_minimal(base_size = 14) +
  theme(strip.text=element_text(size=14, colour="black", face="bold"))+
  theme(panel.grid = element_blank(),
    axis.text=element_text(size=12,colour="black")
  ) +
  labs(title = "Difference in neutrophil phenotype in Corona - Guinness",
       x = "Timepoint", y = NULL)+
        facet_wrap(~label, scales = "free_y", ncol=1)

p
ggsave(plot=p,filename="neut_marker_change_heatmap.png", dpi=300, height=12,width=5)

```

```{r}
emm_list <- list()

for (lab in labels) {

  message("Running models for label (cluster): ", lab)

  # Determine tissue from label name
  tissue_for_label <- ifelse(grepl("_blood$", lab), "blood", "blister")

  message("  Using tissue: ", tissue_for_label)

  # Filter data for correct label + tissue
  model_input_label <- mean_exp %>%
    filter(label == lab, tissue == tissue_for_label)

  for (m in markers) {

    message("    → marker: ", m)

    d <- model_input_label %>% filter(marker == m)

    # Skip if there's no usable data
    if (nrow(d) < 5 || length(unique(d$donor)) < 2) next

    # Mixed model
    mod <- lmer(mean_expression ~ treatment_clean * time_clean + (1 | donor),
                data = d)

    emm <- emmeans(mod, ~ treatment_clean * time_clean)
    emm_df <- as.data.frame(emm)
    emm_df$marker <- m
    emm_df$label  <- lab
    emm_df$tissue <- tissue_for_label

    emm_list[[paste(lab, m, sep = "__")]] <- emm_df
  }
}

emm_results <- bind_rows(emm_list)
```

```{r}
# Plot longitudinal EMMs
emm_results$time_clean <- factor(emm_results$time_clean, levels = c("-72h", "0h", "6h", "24h", "48h", "72h"))

emm_markers <- filter(emm_results, marker %in% c("CD66b", "CD62L"))

p <- ggplot(emm_markers, aes(x = time_clean, y = emmean, color = treatment_clean, group = treatment_clean)) +
  geom_point(size = 3) +
  geom_line(size = 1.2) +
  geom_errorbar(aes(ymin = emmean - SE, ymax = emmean + SE), width = 0.2) +
  facet_wrap(~label+marker,scales="free_y", ncol=2) +
  theme_minimal(base_size = 14) +
  labs(x = "Timepoint", y = "Estimated proportion", color = "Treatment") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  scale_colour_manual(values = c("mediumseagreen", "darkorchid"))+
  theme(axis.text.x = element_text(colour="black", size = 14),
  strip.text=element_text(colour="black", size=12, face="bold"))+
    ylab("Expression")

p
ggsave(plot=p,filename="neut_marker_longitudinal.png", dpi=300,height=12,width=10)
```

## PCA on neutrophil populations at each timepoint to see how if any blister ones sit nearby blood
## of note, i remove (and therefore ignore) expression data of cells which are designated a blood cluster but come from blister and vice-versa

```{r}
library(factoextra)
neuts <- filter(mean_exp, label %in% c("Neutrophil_mature_blood", "Neutrophil_mature_blister", "Neutrophil_aged_blood", "Neutrophil_immature_blood", "Neutrophil_aged_blister"))
neuts <- filter(neuts, marker %in% c("CD16", "CD14", "CCR6", "CD47","CD66b", "HLA-DR", "CD182", "CD184", "CD15", "CD11b"))
neuts$sample_id <- paste0(neuts$sample_full, "_", neuts$label)
pca_input <- neuts %>% filter((grepl("_blood", label) & tissue == "blood") | (grepl("_blister", label) & tissue == "blister"))
pca_input <- pivot_wider(pca_input, names_from = marker, values_from = mean_expression)
metadata <- pca_input[, c(1:6)]
pca_input <- pca_input[, c(7:16)]
rownames(pca_input) <- pca_input$sample_id
pca_input <- pca_input[, -1]
```

## run pca and view pc contributions
```{r}
pca_res <- prcomp(pca_input)
contrib <- fviz_eig(pca_res)
contrib
contrib_numbers <- contrib@data
```

## pull out results for plotting
```{r}
pca_data <- pca_res$x
pca_data <- cbind(pca_data, metadata)
pca_data$label <- factor(pca_data$label, levels = c("Neutrophil_immature_blood", "Neutrophil_mature_blood", "Neutrophil_aged_blood", "Neutrophil_mature_blister", "Neutrophil_aged_blister"))
pca_data$time_clean <- factor(pca_data$time_clean, levels=c("-72h", "0h", "6h", "24h", "48h", "72h"))

loadings <- pca_res$rotation

pc1_df <- data.frame(
  marker = rownames(loadings),
  loading = loadings[, "PC1"],
  abs_loading = abs(loadings[, "PC1"])
) %>%
  arrange(desc(abs_loading))

pc2_df <- data.frame(
  marker = rownames(loadings),
  loading = loadings[, "PC2"],
  abs_loading = abs(loadings[, "PC2"])
) %>%
  arrange(desc(abs_loading))
```

## plot results
```{r}
library(ggforce)
p1 <- ggplot(pca_data, aes(x=PC1,y=PC2,colour=label,shape=treatment_clean))+geom_point()+
  facet_wrap(~treatment_clean+time_clean, ncol=6)+theme_minimal()+scale_colour_manual(values =c("indianred2", "red", "darkred", "steelblue", "blue"))+theme(strip.text=element_text(size=14, colour="black", face="bold"))+theme(legend.position="bottom")+guides(colour=guide_legend(ncol=2))+xlab("PC1 (85.8%)")+ylab("PC2 (13.3%)")+
  theme(axis.title=element_text(size=14, colour="black", face="bold"))+
  scale_fill_manual(values = c("blood" = "orange", "blister" = "purple"))+
  stat_ellipse(aes(fill=label, group=label,colour=NULL), geom="polygon", alpha=0.3)+scale_fill_manual(values =c("indianred2", "red", "darkred", "steelblue", "blue"))
p1
ggsave(plot=p1, filename="neutrophil_pca.png", dpi=300,height=8, width=12)
```

## plot loadings
```{r}
pc1_loadings <- ggplot(pc1_df, aes(x=abs_loading,y=reorder(marker, abs_loading)))+geom_point(colour="black",size=5)+geom_segment(aes(y=reorder(marker,abs_loading), yend=reorder(marker,abs_loading), x=0, xend=abs_loading), linewidth=1)+theme_minimal()+
  theme(axis.text=element_text(size=12,colour="black"))+theme(axis.title=element_text(size=16,colour="black", face="bold"))+xlab("Contribution to PC1")+ylab(NULL)
pc1_loadings
ggsave(plot=pc1_loadings, filename="neut_PC1_loadings.png", dpi=300, height=4,width=5)

ggplot(pc2_df, aes(x=abs_loading,y=reorder(marker, abs_loading)))+geom_point(colour="black",size=5)+geom_segment(aes(y=reorder(marker,abs_loading), yend=reorder(marker,abs_loading), x=0, xend=abs_loading), linewidth=1)+theme_minimal()+
  theme(axis.text=element_text(size=12,colour="black"))+theme(axis.title=element_text(size=16,colour="black", face="bold"))+xlab("PC2 loading")+ylab(NULL)
```
