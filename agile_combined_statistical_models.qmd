---
title: "Untitled"
format: html
---

```{r}
library(lme4)
library(lmerTest)   # adds p-values to lmer
library(emmeans)    # estimated marginal means
library(dplyr)
library(purrr)
library(readr)
library(viridis)
library(readxl)
library(ggplot2)
library(tidyr)
library(RColorBrewer)
library(patchwork)
```

```{r}
blood_df <- read.csv("agile_blood_proportions_df.csv")
blister_df <- read.csv("agile_blister_proportions_df.csv")
donor_info <- read_xlsx("Participant_info.xlsx")
donor_info$donor <- donor_info$`Participant ID`
blood_df <- blood_df %>%
  left_join(donor_info %>% select(donor, Age,), by = "donor")
blister_df <- blister_df %>%
  left_join(donor_info %>% select(donor, Age,), by = "donor")
```

```{r}
## Factors
blood_df$time_clean <- factor(blood_df$time_clean, levels = c("-72h","0h","6h","24h","48h","72h"))
blood_df$treatment_clean <- factor(blood_df$treatment_clean)

## Unique clusters
clusters <- unique(blood_df$label)

## Storage
interaction_list <- list()

for (cl in clusters) {
  
  message("Running model for cluster: ", cl)
  
  d <- blood_df %>% filter(label == cl)
  
  # Fit mixed model
  m <- lmer(prop ~ treatment_clean * time_clean + Age + (1 | donor), data = d)
  
  # EMMs
  emm <- emmeans(m, ~ treatment_clean * time_clean)
  
  # Treatment contrasts within each timepoint
  inter <- contrast(emm, method = "pairwise", by = "time_clean")
  inter_df <- as.data.frame(inter)
  inter_df$label <- cl
  
  # FDR correction within **each cluster × time**
  inter_df <- inter_df %>%
    group_by(time_clean) %>%
    mutate(p_adj_fdr = p.adjust(p.value, method = "fdr")) %>%
    ungroup()
  
  # Keep only the treatment comparison of interest (e.g., "drug - control")
  inter_df <- inter_df %>% filter(grepl("-", contrast))
  
  interaction_list[[cl]] <- inter_df
}

## Combine all clusters
interaction_results <- bind_rows(interaction_list)

## Save results
write_csv(interaction_results, "interaction_results_FDR_cluster_time.csv")
message("Saved: interaction_results_FDR_cluster_time.csv")

## Heatmap
heatmap_df <- interaction_results %>%
  select(label, time_clean, p_adj_fdr) %>%
  mutate(sig = case_when(
    p_adj_fdr < 0.001 ~ "***",
    p_adj_fdr < 0.01  ~ "**",
    p_adj_fdr < 0.05  ~ "*",
    TRUE ~ ""
  ))

ggplot(heatmap_df, aes(x = time_clean, y = label, fill = -log10(p_adj_fdr))) +
  geom_tile(color = "white") +
  geom_text(aes(label = sig), color = "white", size = 10) +
  scale_fill_viridis(option = "rocket", direction = 1, limits = c(0,1), name = "FDR p-value") +
  theme_minimal(base_size = 14) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid = element_blank()
  ) +
  labs(title = "Treatment Differences per Cluster × Timepoint",
       x = "Timepoint", y = "Cluster")

heatmap_df_blood <- interaction_results %>%
  select(label, time_clean, p_adj_fdr, estimate) %>%
  mutate(sig = case_when(
    p_adj_fdr < 0.001 ~ "***",
    p_adj_fdr < 0.01  ~ "**",
    p_adj_fdr < 0.05  ~ "*",
    TRUE ~ ""
  ))

p_blood <- ggplot(heatmap_df_blood, aes(x = time_clean, y = label, fill = estimate)) +
  geom_tile(colour="black")+
  geom_text(aes(label = sig), color = "black", size = 10) +
  scale_fill_distiller(palette = "RdBu", n = "Difference") +
  theme_minimal(base_size = 14) +
  theme(panel.grid = element_blank(),
    axis.text=element_text(size=12,colour="black")
  ) +
  labs(title = "Difference in blood cluster proportions Guinness vs Corona",
       x = "Timepoint", y = "Cluster")
p_blood

```

```{r}
## Factors
blister_df$time_clean <- factor(blister_df$time_clean, levels = c("6h","24h","48h","72h"))
blister_df$treatment_clean <- factor(blister_df$treatment_clean)

## Unique clusters
clusters <- unique(blister_df$label)

## Storage
interaction_list <- list()

for (cl in clusters) {
  
  message("Running model for cluster: ", cl)
  
  d <- blister_df %>% filter(label == cl)
  
  # Fit mixed model
  m <- lmer(prop ~ treatment_clean * time_clean + Age + (1 | donor), data = d)
  
  # EMMs
  emm <- emmeans(m, ~ treatment_clean * time_clean)
  
  # Treatment contrasts within each timepoint
  inter <- contrast(emm, method = "pairwise", by = "time_clean")
  inter_df <- as.data.frame(inter)
  inter_df$label <- cl
  
  # FDR correction within **each cluster × time**
  inter_df <- inter_df %>%
    group_by(time_clean) %>%
    mutate(p_adj_fdr = p.adjust(p.value, method = "fdr")) %>%
    ungroup()
  
  # Keep only the treatment comparison of interest (e.g., "drug - control")
  inter_df <- inter_df %>% filter(grepl("-", contrast))
  
  interaction_list[[cl]] <- inter_df
}

## Combine all clusters
interaction_results <- bind_rows(interaction_list)

## Save results
write_csv(interaction_results, "interaction_results_FDR_cluster_time.csv")
message("Saved: interaction_results_FDR_cluster_time.csv")

## Heatmap
heatmap_df <- interaction_results %>%
  select(label, time_clean, p_adj_fdr, estimate) %>%
  mutate(sig = case_when(
    p_adj_fdr < 0.001 ~ "***",
    p_adj_fdr < 0.01  ~ "**",
    p_adj_fdr < 0.05  ~ "*",
    TRUE ~ ""
  ))

ggplot(heatmap_df, aes(x = time_clean, y = label, fill = p_adj_fdr)) +
  geom_tile(color = "white") +
  geom_text(aes(label = sig), color = "white", size = 10) +
  scale_fill_viridis(option = "rocket", direction = 1, limits = c(0,1), name = "FDR p-value") +
  theme_minimal(base_size = 14) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid = element_blank()
  ) +
  labs(title = "Treatment Differences per Cluster × Timepoint",
       x = "Timepoint", y = "Cluster")

heatmap_df_blister <- interaction_results %>%
  select(label, time_clean, p_adj_fdr, estimate) %>%
  mutate(sig = case_when(
    p_adj_fdr < 0.001 ~ "***",
    p_adj_fdr < 0.01  ~ "**",
    p_adj_fdr < 0.05  ~ "*",
    TRUE ~ ""
  ))

p_blister <- ggplot(heatmap_df_blister, aes(x = time_clean, y = label, fill = estimate)) +
  geom_tile(colour="black")+
  geom_text(aes(label = sig), color = "black", size = 10) +
  scale_fill_distiller(palette = "RdBu", n = "Difference") +
  theme_minimal(base_size = 14) +
  theme(panel.grid = element_blank(),
    axis.text=element_text(size=12,colour="black")
  ) +
  labs(title = "Difference in blister cluster proportions Guinness vs Corona",
       x = "Timepoint", y = "Cluster")

p_blister
```

```{r}
heatmap_df_blood$tissue <- "blood"
heatmap_df_blister$tissue <- "blister"
heatmap_df_combined <- rbind(heatmap_df_blood, heatmap_df_blister)

p1  <- quantile(heatmap_df_combined$estimate, 0.01, na.rm = TRUE)
p99 <- quantile(heatmap_df_combined$estimate, 0.99, na.rm = TRUE)
lim <- max(abs(p1), abs(p99))

heatmap_df_combined <- heatmap_df_combined %>%
  mutate(estimate_capped = pmax(pmin(estimate, lim), -lim))


heatmap_plot_combined <- ggplot(heatmap_df_combined, aes(x = time_clean, y = label, fill = estimate_capped)) +
  geom_tile(colour="black")+
  geom_text(aes(label = sig), color = "black", size = 5, vjust = 0.5, hjust = 0.5) +
  scale_fill_distiller(palette = "RdBu", n = "Difference", limits=c(-lim,lim)) +
  theme_minimal(base_size = 14) +
  theme(panel.grid = element_blank(),
    axis.text=element_text(size=12,colour="black")
  ) +
  labs(title = "Difference in cluster proportions Corona - Guinness",
       x = "Timepoint", y = NULL)+
        facet_wrap(~tissue, scales = "free_y", ncol=1)

heatmap_plot_combined
```

```{r}
emm_list <- list()
clusters <- unique(blood_df$label)

for(cl in clusters){
  
  d <- blood_df %>% filter(label == cl)
  
  # Fit mixed model
  m <- lmer(prop ~ treatment_clean * time_clean + Age + (1 | donor), data = d)
  
  # Estimated marginal means
  emm <- emmeans(m, ~ treatment_clean | time_clean)
  emm_df <- as.data.frame(emm)
  emm_df$label <- cl
  
  emm_list[[cl]] <- emm_df
}

emm_results_blood <- bind_rows(emm_list)

# Plot longitudinal EMMs
ggplot(emm_results_blood, aes(x = time_clean, y = emmean, color = treatment_clean, group = treatment_clean)) +
  geom_point(size = 3) +
  geom_line(size = 1.2) +
  geom_errorbar(aes(ymin = emmean - SE, ymax = emmean + SE), width = 0.2) +
  facet_wrap(~ label, scales = "free_y") +
  theme_minimal(base_size = 14) +
  labs(x = "Timepoint", y = "Estimated proportion", color = "Treatment") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  scale_colour_manual(values = c("mediumseagreen", "darkorchid"))+
  theme(axis.text = element_text(colour="black", size = 14),
  strip.text=element_text(colour="black", size=16, face="bold"))+
    ylab("Estimated % of blood cells")
```

```{r}
emm_list <- list()
clusters <- unique(blister_df$label)

for(cl in clusters){
  
  d <- blister_df %>% filter(label == cl)
  
  # Fit mixed model
  m <- lmer(prop ~ treatment_clean * time_clean + Age + (1 | donor), data = d)
  
  # Estimated marginal means
  emm <- emmeans(m, ~ treatment_clean | time_clean)
  emm_df <- as.data.frame(emm)
  emm_df$label <- cl
  
  emm_list[[cl]] <- emm_df
}

emm_results_blister <- bind_rows(emm_list)

# Plot longitudinal EMMs
ggplot(emm_results_blister, aes(x = time_clean, y = emmean, color = treatment_clean, group = treatment_clean)) +
  geom_point(size = 3) +
  geom_line(size = 1.2) +
  geom_errorbar(aes(ymin = emmean - SE, ymax = emmean + SE), width = 0.2) +
  facet_wrap(~ label, scales = "free_y") +
  theme_minimal(base_size = 14) +
  labs(x = "Timepoint", y = "Estimated proportion", color = "Treatment") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  scale_colour_manual(values = c("mediumseagreen", "darkorchid"))+
  theme(axis.text = element_text(colour="black", size = 14),
  strip.text=element_text(colour="black", size=16, face="bold"))+
    ylab("Estimated % of blister cells")
```

```{r}
emm_all <- rbind(emm_results_blood, emm_results_blister)
emm_all$celltype <- sub("_[^_]+$", "", emm_all$label)
emm_all$tissue <- sub(".*_", "", emm_all$label)
emm_all$group <- paste0(emm_all$tissue, "_", emm_all$treatment_clean)

ggplot(emm_all, aes(x = time_clean, y = emmean, color = group, group = group, shape = group)) +
  geom_point(size = 3, position=position_dodge(width=0.5)) +
  geom_line(size = 1.2, position=position_dodge(width=0.5)) +
  geom_errorbar(aes(ymin = emmean - SE, ymax = emmean + SE), width = 0.2, position=position_dodge(width=0.5)) +
  facet_wrap(~ celltype, scales = "free_y") +
  theme_minimal(base_size = 14) +
  labs(x = "Timepoint", y = "Estimated % of blood/blister cells") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  scale_colour_manual(values = c("mediumseagreen", "palevioletred2", "darkgreen", "darkorchid"))+
  theme(axis.text = element_text(colour="black", size = 14),
  strip.text=element_text(colour="black", size=16, face="bold"))+
    scale_shape_manual(values=c(16,15,17,18))
```

## plot only specific celltypes based on the initial heatmap
```{r}
emm_all <- filter(emm_all, label %in% c("CD4+T_blood", "CD4+T_blister", "Neutrophil_mature_blood", "Neutrophil_mature_blister", "Neutrophil_aged_blood", "Neutrophil_young_blood", "Neutrophil_aged_blister", "DC_blister", "CD1c+_blister"))

longitudinal_plots <- ggplot(emm_all, aes(x = time_clean, y = emmean, color = group, group = group, shape = group)) +
  geom_point(size = 3, position=position_dodge(width=0.5)) +
  geom_line(size = 1.2, position=position_dodge(width=0.5)) +
  geom_errorbar(aes(ymin = emmean - SE, ymax = emmean + SE), width = 0.2, position=position_dodge(width=0.5)) +
  facet_wrap(~ celltype, scales = "free_y") +
  theme_minimal(base_size = 14) +
  labs(x = "Timepoint", y = "Estimated % of blood/blister cells") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  scale_colour_manual(values = c("mediumseagreen", "palevioletred2", "darkgreen", "darkorchid"))+
  theme(axis.text = element_text(colour="black", size = 12),
  strip.text=element_text(colour="black", size=12, face="bold"))+
    scale_shape_manual(values=c(16,15,17,18))
longitudinal_plots
```

## combine heatmap and long plots into one
```{r}
plot_final <- heatmap_plot_combined+longitudinal_plots+plot_layout(ncol=2, widths=c(1,3))
plot_final
ggsave(plot=plot_final, filename="proportions_over_time.png", dpi=300,
height=6, width=14)
```

## to try and plot this data in a digestible way, i'm taking inspiration from the dotplot style longitdinal proportion data you see in scRNA-seq papers
```{r}
ggplot(emm_all, aes(x=time_clean, y = celltype, fill = estimated_mean, size = ))
```

## modelling marker expression
## start with an overview heatmap to see if there are notable patterns
```{r}
summary_df <- read.csv("agile_combined_expression_df.csv")
summary_df <- summary_df[, -c(1:3, 9:12, 16:22)]
summary_df <-  pivot_longer(summary_df, names_to="marker", values_to="expression", cols=9:39)
sample_check <- summary_df %>%
  group_by(treatment_clean, time_clean, tissue) %>%
  summarise(n_samples = n_distinct(sample_full)) %>%
  ungroup()

sample_check

mean_exp <- summary_df %>% group_by(sample_full, donor, time_clean, treatment_clean, label, tissue,marker) %>% summarise(mean_expression = mean(expression), .groups="drop")
```

## for this to make sense, blister/blood populations should only have the times they were actually collected. additionally, only markers relevant to clusters should be shown, so further subsetting required. finally, scaled expression required too
```{r}
neuts <- filter(mean_exp, label %in% c("Neutrophil_mature_blood", "Neutrophil_mature_blister", "Neutrophil_aged_blood", "Neutrophil_young_blood", "Neutrophil_aged_blister"))
neuts <- filter(neuts, marker %in% c("CD16", "CD62L", "CD182", "CD184", "CD15"))
ggplot(neuts, aes(x=time_clean, y = marker, fill = mean_expression))+geom_tile()+facet_wrap(~label)

```

```{r}
markers <- unique(neuts$marker)
celltype <- c("Neutrophil_mature_blister")
tissue_type <- "blister"
model_input <- neuts %>% 
  filter(label %in% celltype, tissue == tissue_type)
analyse_marker <- function(marker_name) {
  dat_marker <- model_input %>% filter(marker == marker_name)
  print(unique(dat_marker$label))
  print(unique(dat_marker$tissue))
  print(table(dat_marker$treatment_clean, dat_marker$time_clean))
  model <- tryCatch({
    lmer(
      mean_expression ~ treatment_clean * time_clean + (1 | donor),
      data = dat_marker
    )
  }, error = function(e) {
    message(paste("Model failed for marker", marker_name))
    return(NULL)
  })
  
  if (is.null(model)) return(NULL)
  
  emm <- emmeans(model, ~ treatment_clean | time_clean, type = "response")
  contrasts <- contrast(emm, method = "pairwise")
  list(
    marker = marker_name,
    model_summary = summary(model),
    emmeans = emm,
    contrasts = contrasts
  )
}
```

## run the model and get the results
```{r}
results_list <- lapply(markers, analyse_marker)
names(results_list) <- markers

# Filter out clusters where model failed (if any)
results_list <- results_list[!sapply(results_list, is.null)]

# Example: access contrasts for the first cluster
print(results_list[[1]]$contrasts)
```

## here we access the results list, pulling out the emmeans and contrasts with a function
## then combine into usable dataframes
```{r}
# Function to get EMMs + contrasts with p-values for plotting
extract_emm_and_contrasts <- function(marker_name, results_list) {
  emm_df <- as.data.frame(results_list[[marker_name]]$emmeans)
  contrasts_df <- as.data.frame(results_list[[marker_name]]$contrasts)
  
  # Add cluster ID to both
  emm_df$marker <- marker_name
  contrasts_df$marker <- marker_name
  
  list(emm = emm_df, contrast = contrasts_df)
}

# Apply to all clusters
emm_contrast_list <- lapply(names(results_list), extract_emm_and_contrasts, results_list = results_list)

# Combine into data frames
emm_all <- bind_rows(lapply(emm_contrast_list, `[[`, "emm"))
contrast_all <- bind_rows(lapply(emm_contrast_list, `[[`, "contrast"))
```

## add a column specifying if a result was significant so that we can use these in the plot
## add a value that is above the upper confidence interval by a little bit so that the asterisks will sit above them on the plot
## join these columns back in witht he contrasts_all df
```{r}
# Extract timepoint and treatment comparison from contrast row names
contrast_all <- contrast_all %>%
  mutate(
    sig_label = case_when(
      p.value < 0.001 ~ "***",
      p.value < 0.01 ~ "**",
      p.value < 0.05 ~ "*",
      TRUE ~ ""
    )
  )

max_prob <- emm_all %>%
  group_by(marker) %>%
  summarise(max_y = max(upper.CL, na.rm = TRUE)) %>%
  mutate(label_y = max_y +0.005)

contrast_all <- contrast_all %>%
  left_join(max_prob, by = "marker")
```

## plot the results and save
```{r}
plot1 <- ggplot(emm_all, aes(x = time_clean, y = emmean, colour = treatment_clean, group = treatment_clean)) +
  geom_line(position = position_dodge(width=0.4), size=0.8) +
  geom_point(position = position_dodge(width=0.4),size=2) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width = 0.2,
  position = position_dodge(width=0.4),size=0.8) +
  geom_text(
    data = contrast_all %>% filter(sig_label != ""),
    aes(x = time_clean, y = label_y, label = sig_label),
    inherit.aes = FALSE,
    size = 7
  ) +
  facet_wrap(~marker, scales = "free_y") +
  labs(
    title = paste0(celltype, " marker expression"),
    y = paste0("Expression"),
    x = "Timepoint",
    colour = "Treatment"
  ) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+scale_colour_manual(values=c("mediumseagreen", "darkorchid2"))+ 
  scale_y_continuous(expand = expansion(mult = c(0.05, 0.15)))+
  theme(axis.text = element_text(size = 12, colour = "black"),
  strip.text = element_text(size = 12, colour = "black", face = "bold"),
  axis.title = element_text(size = 14, colour = "black"))+ 
    theme(legend.text = element_text(size = 14),legend.title = element_text(size = 15))+
  guides(colour = guide_legend(override.aes = list(size = 5)))
plot1
#change name of plot if neuts are excluded
ggsave(plot=plot1,filename=paste0(celltype, "_marker_expression.png"), dpi = 500,
height = 8, width = 12, bg="white")
```

```{r}
markers <- unique(neuts$marker)
celltype <- c("Neutrophil_mature_blister")
tissue_type <- "blister"
neuts$time_clean <- factor(neuts$time_clean, levels = c("-72h", "0h", "6h","24h","48h","72h"))
model_input <- neuts %>% 
  filter(label %in% celltype, tissue == tissue_type)
interaction_list <- list()

for (m in markers) {
  
  message("Running model for cluster: ", m)
  
  d <- model_input %>% filter(marker == m)
  
  # Fit mixed model
  mod <- lmer(mean_expression ~ treatment_clean * time_clean + (1 | donor), data = d)
  
  # EMMs
  emm <- emmeans(mod, ~ treatment_clean * time_clean)
  
  # Treatment contrasts within each timepoint
  inter <- contrast(emm, method = "pairwise", by = "time_clean")
  inter_df <- as.data.frame(inter)
  inter_df$label <- m
  
  # FDR correction within **each cluster × time**
  inter_df <- inter_df %>%
    group_by(time_clean) %>%
    mutate(p_adj_fdr = p.adjust(p.value, method = "fdr")) %>%
    ungroup()
  
  # Keep only the treatment comparison of interest (e.g., "drug - control")
  inter_df <- inter_df %>% filter(grepl("-", contrast))
  
  interaction_list[[m]] <- inter_df
}

## Combine all clusters
interaction_results <- bind_rows(interaction_list)

heatmap_df_blister <- interaction_results %>%
  select(label, time_clean, p_adj_fdr, estimate) %>%
  mutate(sig = case_when(
    p_adj_fdr < 0.001 ~ "***",
    p_adj_fdr < 0.01  ~ "**",
    p_adj_fdr < 0.05  ~ "*",
    TRUE ~ ""
  ))

p_blister <- ggplot(heatmap_df_blister, aes(x = time_clean, y = label, fill = estimate)) +
  geom_tile(colour="black")+
  geom_text(aes(label = sig), color = "black", size = 10) +
  scale_fill_distiller(palette = "RdBu", n = "Difference") +
  theme_minimal(base_size = 14) +
  theme(panel.grid = element_blank(),
    axis.text=element_text(size=12,colour="black")
  ) +
  labs(title = "Difference in marker expression Corona - Guinness",
       x = "Timepoint", y = "Cluster")

p_blister
```